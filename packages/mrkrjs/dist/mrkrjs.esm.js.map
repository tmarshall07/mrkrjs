{"version":3,"file":"mrkrjs.esm.js","sources":["../src/Mrkr.ts"],"sourcesContent":["type OffsetProps = {\n  startOffset?: number;\n  endOffset?: number;\n};\n\ntype DataProps = OffsetProps & {\n  text: string;\n  nodes: Text[];\n};\n\n// Type guard for Text nodes\nfunction isTextNode(node: Node): node is Text {\n  return (node as Text).nodeType === 3;\n}\n\n// Type guard for offset\nfunction isValidOffset(offset?: OffsetProps): offset is { startOffset: number; endOffset: number } {\n  return !!(offset && typeof offset.startOffset === 'number' && typeof offset.endOffset === 'number');\n}\n\n/**\n * Gets an array of text nodes under the passed node\n *\n * @param {HTMLElement} node\n * @returns {[HTMLElement]} - array of text nodes\n */\nconst textNodesUnder = (node: any): Text[] => {\n  let all: Text[] = [];\n\n  // eslint-disable-next-line no-param-reassign\n  for (node = node.firstChild; node; node = node.nextSibling) {\n    if (isTextNode(node)) all.push(node);\n    else all = all.concat(textNodesUnder(node));\n  }\n  return all;\n};\n\ninterface Props {\n  element?: HTMLElement;\n  className?: string;\n  minimum?: number;\n  maximum?: number;\n  overlap?: boolean;\n  onSelection?: (e: PointerEvent, data: DataProps[]) => void;\n}\n\ninterface Range {\n  startContainer: ChildNode;\n  endContainer: ChildNode;\n  startOffset: number;\n  endOffset: number;\n}\n\nexport default class Mrkr {\n  element: HTMLElement;\n\n  highlightClass: string;\n\n  maximum?: number;\n\n  minimum?: number;\n\n  overlap?: boolean;\n\n  onSelection?: (e: PointerEvent, data: DataProps[]) => void;\n\n  private selectionEnabled: boolean;\n\n  constructor(props: Props = {}) {\n    const {\n      element = document.body,\n      className = 'highlight',\n      onSelection,\n      maximum = undefined,\n      minimum = undefined,\n      overlap = true,\n    } = props;\n\n    this.element = element;\n    this.highlightClass = className;\n    this.selectionEnabled = false;\n    this.maximum = maximum;\n    this.minimum = minimum;\n    this.overlap = overlap;\n    this.onSelection = onSelection;\n\n    this.handlePointerUp = this.handlePointerUp.bind(this);\n\n    this.setElement(element);\n  }\n\n  /**\n   * Callback run on pointerup\n   *\n   * @private\n   * @param {PointerEvent} event\n   * @memberof Mrkr\n   */\n  private handlePointerUp(event: PointerEvent) {\n    if (this.selectionEnabled) {\n      const results = this.highlight();\n\n      if (this.onSelection) this.onSelection(event, results);\n    }\n  }\n\n  /**\n   * Gets all nodes that have the current className\n   *\n   * @private\n   * @returns {HTMLElement[]}\n   * @memberof Mrkr\n   */\n  private getHighlightedNodes(className?: string): HTMLElement[] {\n    if (!this.element) return [];\n\n    return Array.from(this.element.querySelectorAll(`.${className || this.highlightClass}`));\n  }\n\n  /**\n   * Creates a set of highlighted and non-highlighted nodes to replace the passed text content\n   *\n   * @private\n   * @param {(string | null)} [text='']\n   * @param {number} startOffset\n   * @param {number} endOffset\n   * @returns {ChildNode[]}\n   * @memberof Mrkr\n   */\n  private highlightNode(text: string | null = '', startOffset: number, endOffset: number): ChildNode[] {\n    if (!text) return [];\n\n    const highlightedText = text.substring(startOffset, endOffset);\n\n    if (highlightedText.length > 0) {\n      const highlightedSpanNode = document.createElement('SPAN');\n      highlightedSpanNode.classList.add(this.highlightClass);\n\n      const startTextNode = document.createTextNode(text.substring(0, startOffset));\n      const highlightedTextNode = document.createTextNode(highlightedText);\n      const endTextNode = document.createTextNode(text.substring(endOffset));\n\n      highlightedSpanNode.appendChild(highlightedTextNode);\n\n      const newNodes = [];\n      if (startTextNode.textContent) newNodes.push(startTextNode);\n      newNodes.push(highlightedSpanNode);\n      if (endTextNode.textContent) newNodes.push(endTextNode);\n\n      return newNodes;\n    }\n\n    return [document.createTextNode(text)];\n  }\n\n  /**\n   * Converts relative range offset data to absolute offsets\n   *\n   * @private\n   * @memberof Mrkr\n   */\n  private getAbsoluteOffsets = (\n    startContainer: Text,\n    startOffset: number,\n    endContainer: Text,\n    endOffset: number,\n  ): OffsetProps => {\n    const textNodes = textNodesUnder(this.element);\n    let currentIndex = 0;\n    let absoluteStartOffset;\n    let absoluteEndOffset;\n\n    textNodes.some((textNode) => {\n      if (!textNode?.textContent) return false;\n\n      if (textNode === startContainer) {\n        absoluteStartOffset = currentIndex + startOffset;\n      }\n\n      if (textNode === endContainer) {\n        absoluteEndOffset = currentIndex + endOffset;\n        return true;\n      }\n\n      currentIndex += textNode.textContent.length;\n      return false;\n    });\n\n    if (absoluteStartOffset && absoluteEndOffset) {\n      return { startOffset: absoluteStartOffset, endOffset: absoluteEndOffset };\n    }\n\n    return {};\n  };\n\n  /**\n   * Adds the event listener for pointerup\n   *\n   * @memberof Mrkr\n   */\n  private register(): void {\n    this.element.addEventListener('pointerup', this.handlePointerUp);\n  }\n\n  /**\n   * Removes the event listener for pointerup\n   *\n   * @memberof Mrkr\n   */\n  private unregister(): void {\n    this.element.removeEventListener('pointerup', this.handlePointerUp);\n  }\n\n  /**\n   * Sets the current classname\n   *\n   * @param {string} className\n   * @memberof Mrkr\n   */\n  setClassName(className: string): void {\n    this.highlightClass = className;\n  }\n\n  /**\n   * Searches the container element for any highlighted nodes\n   * according to the current className\n   *\n   * @param {string} [className] - optional classname, otherwise will check for this.highlightClass\n   * @returns {DataProps[]}\n   * @memberof Mrkr\n   */\n  getData(className?: string): DataProps[] {\n    if (!this.element) return [];\n\n    const textNodes = textNodesUnder(this.element);\n    const highlightedTextNodes = this.getHighlightedNodes(className).reduce(\n      (arr: Text[], current) => [...arr, ...textNodesUnder(current)],\n      [],\n    );\n\n    let currentIndex = 0;\n\n    let startFound = false;\n\n    const data: DataProps[] = [];\n\n    textNodes.some((textNode, i) => {\n      if (!textNode.textContent) return false;\n\n      const highlightedTextNode = highlightedTextNodes.find((node) => node === textNode);\n\n      if (highlightedTextNode) {\n        if (!startFound) {\n          data.push({\n            startOffset: currentIndex,\n            text: textNode.textContent,\n            nodes: [highlightedTextNode],\n          });\n\n          startFound = true;\n        } else {\n          data[data.length - 1].text += textNode.textContent;\n          data[data.length - 1].nodes.push(highlightedTextNode);\n        }\n\n        // If this node is also the last node\n        if (i === textNodes.length - 1) {\n          data[data.length - 1].endOffset = currentIndex + textNode.textContent.length;\n        }\n      } else if (startFound) {\n        data[data.length - 1].endOffset = currentIndex;\n        startFound = false;\n      }\n\n      currentIndex += textNode.textContent.length;\n\n      return false;\n    });\n\n    return data;\n  }\n\n  /**\n   * Sets the current container element\n   *\n   * @param {HTMLElement} element\n   * @memberof Mrkr\n   */\n  setElement(element: HTMLElement): void {\n    this.unregister();\n    this.element = element;\n    this.register();\n  }\n\n  /**\n   * Clears all or part of the highlighted text blocks\n   *\n   * @param {OffsetProps[]} [offsetTargets] - optional array of offsets to target and remove\n   * @returns {void}\n   * @memberof Mrkr\n   */\n  clear(offsetTargets?: OffsetProps[]): void {\n    if (!this.element) return;\n\n    // Guard against bad offset inputs\n    const offsets = offsetTargets?.filter((o) => isValidOffset(o));\n\n    const highlightedNodes = this.getHighlightedNodes();\n    const textNodes = textNodesUnder(this.element);\n\n    // If offsets array not included, clear all\n    if (!offsets) {\n      highlightedNodes.forEach((highlightedNode) => {\n        highlightedNode.replaceWith(...Array.from(highlightedNode.childNodes));\n      });\n    } else {\n      // Clear all highlighted text that falls between the offsets in the passed offsets array\n      let currentIndex = 0;\n\n      // Clear any text nodes that fall inside any of the offset ranges passed\n      textNodes.some((textNode) => {\n        if (\n          offsets.find(\n            (offset) => isValidOffset(offset) && currentIndex >= offset.startOffset && currentIndex <= offset.endOffset,\n          )\n        ) {\n          const highlightedNode = highlightedNodes.find(\n            (node) => !!Array.from(node.childNodes).find((n) => n === textNode),\n          );\n          if (highlightedNode) {\n            highlightedNode.replaceWith(...Array.from(highlightedNode.childNodes));\n          }\n        }\n\n        // Can stop searching\n        const ends = offsets.map((offset) => offset.endOffset).filter((n) => typeof n === 'number') as number[];\n        if (currentIndex > Math.max(...ends)) {\n          return true;\n        }\n\n        currentIndex += textNode.textContent?.length || 0;\n        return false;\n      });\n    }\n  }\n\n  highlight(): DataProps[] {\n    const selection = window.getSelection();\n    const results: DataProps[] = [];\n\n    // If there's no selection object\n    if (!selection) return results;\n\n    // Container element must be defined\n    if (!this.element) {\n      console.error(new Error('Container element not defined for highlighter.'));\n      return results;\n    }\n\n    const range = selection.getRangeAt(0);\n\n    const { startContainer, endContainer } = range as unknown as Range;\n\n    // Ensure that results are Text nodes\n    if (isTextNode(startContainer) && isTextNode(endContainer)) {\n      const startTextNode = startContainer;\n      const endTextNode = endContainer;\n\n      // If no content's actually been selected\n      if (startTextNode === endTextNode && range.endOffset === range.startOffset) return results;\n\n      // Convert to absolute offsets in the element\n      const offsets = this.getAbsoluteOffsets(startContainer, range.startOffset, endContainer, range.endOffset);\n\n      // Remove native selection\n      selection.removeAllRanges();\n\n      if (offsets.startOffset && offsets.endOffset) {\n        const length = offsets.endOffset - offsets.startOffset;\n\n        // Check for minimum / maximum\n        const { startOffset, endOffset } = offsets;\n        if ((this.minimum && !(length >= this.minimum)) || (this.maximum && !(length <= this.maximum))) {\n          return results;\n        }\n\n        // Check for overlap\n        if (!this.overlap) {\n          const highlights = this.getData();\n          if (\n            highlights.some(\n              (highlight) =>\n                highlight.startOffset &&\n                highlight.endOffset &&\n                ((startOffset > highlight.startOffset && startOffset < highlight.endOffset) ||\n                  (endOffset > highlight.startOffset && endOffset < highlight.endOffset)),\n            )\n          ) {\n            return results;\n          }\n        }\n      }\n\n      if (isValidOffset(offsets)) {\n        this.highlightRange(offsets.startOffset, offsets.endOffset);\n      }\n\n      return this.getData();\n    }\n\n    return results;\n  }\n\n  /**\n   * Highlights a range of text determined by start and end offsets\n   *\n   * @param {number} startOffset - absolute offset in the element container\n   * @param {number} endOffset - absolute offset in the element container\n   * @returns {DataProps[]}\n   * @memberof Mrkr\n   */\n  highlightRange(startOffset: number, endOffset: number): DataProps[] {\n    const results: DataProps[] = [];\n\n    if (!this.element) {\n      console.error(new Error('Container element not defined for highlighter.'));\n      return results;\n    }\n\n    const textNodes = textNodesUnder(this.element);\n\n    let currentIndex = 0;\n    let startFound = false;\n\n    textNodes.some((textNode) => {\n      if (!textNode.textContent) return false;\n\n      const newCurrentIndex = currentIndex + textNode.textContent.length;\n      if (startOffset >= currentIndex && startOffset < newCurrentIndex) {\n        const newNodes = this.highlightNode(textNode.textContent, startOffset - currentIndex, endOffset - currentIndex);\n        textNode.replaceWith(...newNodes);\n\n        // Start collecting text nodes in between\n        startFound = true;\n      }\n\n      if (endOffset >= currentIndex && endOffset < newCurrentIndex) {\n        const newNodes = this.highlightNode(textNode.textContent, 0, endOffset - currentIndex);\n        textNode.replaceWith(...newNodes);\n\n        // End the loop\n        return true;\n      }\n      if (startFound) {\n        const newNodes = this.highlightNode(textNode.textContent, 0, textNode.textContent.length);\n        textNode.replaceWith(...newNodes);\n      }\n\n      currentIndex = newCurrentIndex;\n      return false;\n    });\n\n    return this.getData();\n  }\n\n  getSelectionEnabled(): boolean {\n    return this.selectionEnabled;\n  }\n\n  toggleSelection(isEnabled: boolean): void {\n    this.selectionEnabled = typeof isEnabled === 'undefined' ? !this.selectionEnabled : isEnabled;\n  }\n\n  enableSelection(): void {\n    this.selectionEnabled = true;\n  }\n\n  disableSelection(): void {\n    this.selectionEnabled = false;\n  }\n}\n"],"names":[],"mappings":"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"}